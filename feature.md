# Feature.md

## Общее описание продукта

Приложение для взаимодействия с Кандидатами и упрощения обработки информации от них. Предполагается 2 этапа связанных друг с другом 

1. Заполнение кандидатом анкеты с сохранением данных о физичеком лице в базу, передаче данных о новом физическом лице на проверку в службу безопасности по электронной почте (анкета) + предусмотреть коннектор для забора данных системой (json). Отслеживание статуса в системе и оповещение специалиста по подбору о том что работник заполнил анкету и он проверен / отклонен. 

2. Если работник прошел проверку, то специалист по подбору оповещает его об этом, у кандидата открывается возможность загрузки сканов / pdf комплекта документов (паспорт, военный билет, инн, СНИЛС и другие) Документы распознаются, запись в базе о кандидате обогащается дополнительными данными из документов. Дальше по решению специалиста по подбору данные могут быть переданы в учетную систему 1С ЗУП (коннектор Json), где на их основе создается карточка физического лица. Функционал доработки 1С ЗУП в рамках данного проекта не рассматривается. Просто отдаем данные через webhook.

Нужно учесть, что все сканы сохраняются и увязываются с записью о кандидате.


## Цели и ключевые требования

Веб-форма анкеты с валидацией и масками полей.

Чекбокс согласия → генерация PDF с подстановкой ответов.

Отправка PDF на e-mail кандидата и рекрутера, логирование статуса доставки.

Надёжное хранение персональных данных (ПДн), следы аудита.

Масштабируемость: обработка пиков (кампании найма), очередь задач.

Готовность к локализации (RU/EN) и к расширению полей.

## Высокоуровневая архитектура (слои и сервисы)

### Frontend

Next.js (React + TypeScript)
React Hook Form + Zod: синхронная/асинхронная валидация, маски (passport, дата).
UI: shadcn/ui + Tailwind.

### API-шлюз / Backend-приложение

NestJS (TypeScript): модульность, DI, декораторы, guards.

Аутентификация (для рекрутера/админа): JWT + refresh, для публичной анкеты — session cookie + CSRF.
Валидация входных данных (class-validator) + нормализация.
Шифрование чувствительных полей на уровне приложения (например, passport_series, passport_number, issuer_code).

### Сервис генерации документов

Шаблоны: Handlebars/ Nunjucks → HTML.

### Рендер в PDF:

Gotenberg
Хранилище PDF

### Сервис рассылки

Очередь: Redis + BullMQ (job’ы: generate_pdf, send_email).

Провайдеры e-mail

Шаблоны писем: MJML/Handlebars.

### База данных

PostgreSQL (основная): транзакции, внешние ключи, JSONB для динамичных полей анкеты.


### Эпик E1. Приглашение кандидата и доступ к анкете

#### US-E1-01. Генерация ссылки-приглашения
Как специалист по подбору, я хочу сгенерировать персональную ссылку на анкету кандидата с истекаемым токеном, чтобы кандидат мог безопасно заполнить анкету без регистрации.

Критерии приёмки

Given я ввожу ФИО, телефон/e-mail кандидата
When нажимаю «Отправить приглашение»
Then создаётся запись «Кандидат (Draft)», генерируется уникальная URL со сроком жизни (напр. 14 дней) и отправляется e-mail/SMS.

Ссылка одноразовая; при повторной активации старая инвалидируется.

Логируется кто/когда отправил приглашение.

#### US-E1-02. Повторная отправка/деактивация ссылки
Как специалист по подбору, я хочу заново отправить ссылку и/или деактивировать действующую, чтобы управлять доступом кандидата.
Критерии: повторная отправка создаёт новый токен, старый — недействителен; в карточке видна история отправок.

### Эпик E2. Анкета кандидата и первичная запись в базе

US-E2-01. Заполнение анкеты без логина

Как кандидат, я хочу открыть ссылку и заполнить анкету по шагам, чтобы отправить данные быстро и без регистрации.

Критерии

Мастер из шагов: Контакты → Паспортные данные → Адрес → Образование/опыт (если нужно) → Согласия.

Валидации формата (телефон, e-mail, серия/номер паспорта, дата рождения).

Кнопка «Сохранить и продолжить позже» (черновик).

Then при «Отправить» создаётся/обновляется запись «Физлицо» (status = QuestionnaireSubmitted) и чекбокс-согласия фиксируется.

#### US-E2-02. Согласия и политика обработки данных

Как кандидат, я хочу дать явные согласия (обработка ПДн, проверка СБ, хранение сканов), чтобы продолжить.

Критерии: без галочек «Согласен» кнопку «Отправить» нажать нельзя; согласия версионируются (текст, версия, дата/время, IP/UA).

US-E2-03. Автосохранение черновика анкеты

Как кандидат, я хочу автосохранение черновика, чтобы не потерять данные при разрыве сессии.

Критерии: автосейв каждые N секунд/на смене шага; срок жизни черновика = срок токена.

### Эпик E3. Передача анкеты в Службу безопасности (СБ)

#### US-E3-01. E-mail пакет в СБ
Как система, я хочу отправить в СБ письмо с анкетой и вложением PDF/JSON, чтобы СБ могла начать проверку.
Критерии

После QuestionnaireSubmitted формируется письмо на настроенный адрес СБ: тема с ФИО/ID, тело — краткое резюме, вложения: questionnaire.pdf и questionnaire.json.

Письмо логируется (message-id, статус отправки).

#### US-E3-02. Коннектор JSON для СБ (pull/webhook)

Как система СБ, я хочу забирать анкету по API (JSON), чтобы не зависеть от e-mail.

Критерии

Доступен GET /api/v1/candidates/{id}/questionnaire (JWT, IP allowlist).

Доступен POST /api/v1/security-check/callback (webhook) для возврата результатов проверки: status: APPROVED | REJECTED | NEEDS_INFO, comment, attachments[] (опц.).

#### US-E3-03. Отслеживание статуса проверки

Как специалист по подбору, я хочу видеть статус СБ (в ожидании/проверен/отклонён), чтобы понимать следующий шаг.

Критерии: Канбан/таблица по статусам; нотификации при смене.

### Эпик E4. Уведомления и события

#### US-E4-01. Уведомление рекрутера о заполнении анкеты

Как специалист по подбору, я хочу получать уведомления, чтобы не мониторить вручную.

Критерии: e-mail/мессенджер/внутренний Inbox; событие QuestionnaireSubmitted.

#### US-E4-02. Уведомление о результате СБ

Как специалист по подбору, я хочу получать уведомления при SecurityCheckApproved/Rejected, чтобы действовать дальше.

Критерии: push/e-mail внутри 1–2 мин. от события.

#### US-E4-03. Уведомление кандидата об успешной проверке

Как система/рекрутер, я хочу оповестить кандидата о прохождении СБ и открыть доступ к загрузке документов, чтобы ускорить онбординг.

Критерии: письмо/SMS со ссылкой «Загрузить документы» (новый токен, scope=documents).

### Эпик E5. Загрузка документов и OCR

#### US-E5-01. Загрузка сканов/фото документов

Как кандидат, я хочу загрузить набор документов (паспорт, военный билет, ИНН, СНИЛС и др.), чтобы завершить оформление.

Критерии

Поддержка PDF/JPEG/PNG; максимум по размеру; drag-and-drop + мультизагрузка; список требуемых и необязательных документов с прогресс-баром.

Автоклассификация по типу (passport/inn/snils/…); возможность исправить тип вручную.

Все файлы сохраняются и связываются с записью кандидата (immutable storage + версия).

#### US-E5-02. OCR/парсинг и верификация полей

Как система, я хочу распознать поля и сопоставить их с анкетой, чтобы обогатить запись.

Критерии

Для паспорта: серия/номер, кем выдан, дата выдачи, код подразделения, ФИО, дата рождения, адрес регистрации (если доступен).

Для ИНН/СНИЛС: номер, валидность по контрольной сумме.

UI сравнения «распознано ↔ анкета», подсветка расхождений, кнопки «Принять/Отменить/Редактировать».

Протокол распознавания (версия движка, уверенность, время).

#### US-E5-03. Контроль комплектности

Как система, я хочу проверять, что обязательные документы загружены, чтобы не отправить неполный пакет в 1С.

Критерии: чек-лист; без «зелёного» статуса по обязательным документам кнопка «Передать в 1С» недоступна.

### Эпик E6. Карточка кандидата и обогащение данных

### US-E6-01. Просмотр и редактирование карточки

Как специалист по подбору, я хочу видеть все данные кандидата (анкета, СБ-статус, документы, распознанные поля), чтобы принимать решение.

Критерии: единая карточка; история изменений с автором, временем и значением «до/после».

#### US-E6-02. Конфликты данных и правила приоритета

Как система, я хочу разрешать конфликты между анкетой и OCR по правилам, чтобы данные были консистентны.

Критерии: матрица приоритета (например, документ > анкета при высокой уверенности); флаг «требует ручного подтверждения».

### Эпик E7. Интеграция с 1С ЗУП

####  US-E7-01. Предпросмотр пакета в 1С

Как специалист по подбору, я хочу видеть, какие данные уйдут в 1С (карточка физлица), чтобы проверить перед отправкой.
Критерии: экран «Предпросмотр» с маппингом полей Система → 1С (таблица).

#### US-E7-02. Отправка данных в 1С ЗУП

Как система, я хочу передать данные в 1С через интеграционный слой (HTTP/Enterprise/файл-обмен), чтобы создать карточку физлица.

Критерии

Webhook со всей информацией о физическом лице в струкутрированном виде - json

#### US-E7-03. Привязка сканов к записи

Как система, я хочу сохранять ссылки на сканы в хранилище и (опционально) передавать их в 1С или ЭДО, чтобы обеспечить полный пакет.

Критерии: хэш-сумма файла, неизменяемость; политика авторизации доступа к файлам.

### Эпик E8. Роли, доступы, аудит

#### US-E8-01. RBAC

Как администратор, я хочу управлять ролями (Recruiter, Security, Admin, Viewer), чтобы ограничивать доступ к ПДн.

Критерии: матрица прав на чтение/редактирование/экспорт/интеграции.

#### US-E8-02. Аудит действий

Как служба безопасности/комплаенс, я хочу видеть журнал действий, чтобы расследовать инциденты.

Критерии: кто/когда/что (сущность/поле «до/после»)/IP/UA; неизменяемый лог.

### Эпик E9. Отчёты и экспорт

#### US-E9-01. Реестр кандидатов и статусы

Как специалист по подбору, я хочу фильтровать/экспортировать список кандидатов по статусам и датам, чтобы вести отчётность.

Критерии: фильтры, колонки настраиваемые, экспорт CSV/XLSX (без сканов).

#### US-E9-02. Экспорт архива

Как администратор, я хочу выгрузить полный архив кандидата (JSON метаданные + сканы), чтобы передать в архив/юридический отдел.

Критерии: zip-пакет, лог выгрузки, контроль доступа.

### Эпик E10. Надёжность, безопасность, соответствие

#### US-E10-01. Политики хранения ПДн

Как владелец системы, я хочу настраивать сроки хранения и маскирование, чтобы соответствовать требованиям законодательства (GDPR/локальные).

Критерии: ретеншн политики, анонимизация по запросу, удаление по праву на забвение (если применимо).

#### US-E10-02. Резервное копирование

Как администратор, я хочу резервное копирование БД и хранилища, чтобы исключить потерю данных.

Критерии: ежедневные бэкапы, периодическое тест-восстановление.




##### Требования к анкете кандидата (этап проверки СБ)

1. Общая структура

Анкета состоит из блоков:

Общие сведения о кандидате

Документы и идентификаторы

Семейное положение и состав семьи

Образование

Владение иностранными языками

Опыт работы за 10 лет

Рекомендации

Дополнительная информация (ИП, ВУ, диспансеры, судимости, родственники в компании)

Подтверждения и согласия

2. Поля анкеты

2.1. Общие сведения

Желаемая должность – обязательное поле.

Фамилия – обязательное.

Изменение фамилии (старая, дата, причина) – необязательное, заполняется при наличии.

Имя – обязательное.

Отчество – обязательное (если отсутствует по паспорту — ставится отметка «нет»).

Дата рождения – обязательное.

Место рождения – обязательное.

Мобильный телефон – обязательное.

Электронная почта – обязательное.

Адрес прописки (с индексом) – обязательное.

Адрес фактического проживания (с индексом) – необязательное (если отличается от прописки).

2.2. Документы

Паспорт: серия, номер, кем и когда выдан, код подразделения – обязательное.

ИНН – обязательное.

СНИЛС – обязательное.

2.3. Семейное положение и состав семьи

Семейное положение – обязательное.

Состав семьи: ФИО (полностью), дата рождения, текущее место работы и должность – обязательное при наличии членов семьи.

Возможность добавления нескольких строк (динамический список: супруг(а), дети, родители, братья/сёстры).

2.4. Образование

Список мест обучения: даты поступления и окончания, наименование учебного заведения, специальность/квалификация.

Обязательное наличие хотя бы одного блока «Основное образование».

Возможность добавления строк (доп. образование, курсы, стажировки).

2.5. Иностранные языки

Наименование языка – необязательное.

Степень владения (из списка: не владею, читаю со словарём, понимаю и объясняюсь, бегло говорю) – обязательное поле при выборе языка.

Возможность добавления строк для нескольких языков.

2.6. Опыт работы (за 10 лет)

Дата приёма (месяц, год) – обязательное.

Дата увольнения (месяц, год) – обязательное.

Полное наименование организации, профиль, телефон – обязательное.

Занимаемая должность – обязательное.

Причина увольнения – обязательное.

Возможность добавления строк (каждое место работы отдельно).

2.7. Рекомендации

ФИО – обязательное.

Место работы, должность – обязательное.

Телефон – обязательное.

Возможность добавления строк (несколько рекомендателей).

2.8. Дополнительная информация

Являетесь ли ИП/учредителем/ген. директором юр. лица – обязательное, булево (да/нет). Если «Да» → уточняющее поле (название/ИНН).

Водительское удостоверение (№, категория, стаж) – необязательное, заполняется при наличии.

Учёт в психоневрологическом/наркологическом диспансере – обязательное, булево (да/нет).

Судимости у кандидата/родственников (вкл. погашенные) – обязательное, булево. Если «Да» → уточнить статьи, даты, сроки.

Родственники/знакомые в AFI Development – обязательное, булево. Если «Да» → указать ФИО.

2.9. Подтверждения и согласия

Подтверждение достоверности данных – обязательное, чекбокс + дата + подпись.

Согласие на обработку ПДн – обязательное, чекбокс + дата + подпись.

3. Динамические разделы

Для следующих разделов необходимо предусмотреть возможность добавления строк:

Состав семьи (массив объектов).

Образование (массив объектов, минимум 1).

Знание иностранных языков (массив объектов).

Опыт работы (массив объектов).

Рекомендации (массив объектов).

4. UX/UI и валидации

Форматные проверки (телефон, e-mail, паспорт, СНИЛС, ИНН, даты).

Чекбоксы «Нет/не применимо» там, где информация может отсутствовать (например, отчество, водительские права).

Поддержка автосохранения черновика.

Соглашение по ПДн и достоверности данных — блокирующее (без согласия «Отправить» недоступно).


##### Триггер и пользовательский сценарий

В конце анкеты показывается чекбокс с текстом согласия (как в документе). Без чекбокса кнопка «Отправить анкету» недоступна.

When кандидат ставит чекбокс и жмёт «Отправить»:

фиксируется юридически значимое действие с метаданными: timestamp, IP, User-Agent, consent_version, consent_text_hash;

генерируется PDF-согласие с автоподстановкой полей;

PDF сохраняется в хранилище;

рассылаются письма с PDF во вложении: кандидату (его e-mail) и рекрутеру.

2) Данные для подстановки в PDF

Из анкеты подставляем в «шапку» согласия (точные строки из шаблона согласия):

ФИО: <Ф.И.О. пользователя которые он ввел в анкету>

Адрес регистрации: <Полный адрес регистрации из анкеты>

Паспорт серия, дата выдачи: <Серия и номер паспорта> + <Дата выдачи>

Кем выдан, к/п: <Кем выдан> + <Код подразделения>

Примечание: если в анкете «Отчество отсутствует», в ФИО выводим только фамилию и имя; пустые поля недопустимы — анкета должна валидироваться раньше (серия/номер/дата/кем выдан/код подразделения — обязательны).

3) Требования к шаблону согласия

Основа — текст из файла «СОГЛАСИЕ…» без правок, с версионированием (version — например, 1.0.0 по дате публикации). Любая правка текста → новая версия.

Шаблон помечается плейсхолдерами:

{{full_name}}, {{registration_address}}, {{passport_series}}, {{passport_number}}, {{passport_issue_date}}, {{passport_issued_by}}, {{passport_subdivision_code}}, {{signed_at}} (дата/время согласия локально).

Внизу добавляется техблок мелким шрифтом (в PDF, не в юридическом тексте):
Согласие версии {{consent_version}}. Хеш текста: {{consent_text_hash}}. Источник: анкета №{{candidate_id}}. IP: {{ip}}, UA: {{user_agent}}.

4) Генерация PDF (варианты реализации)

Вариант A (рекомендуется, т.к. у вас уже используется Gotenberg):

Храним шаблон в HTML (с плейсхолдерами Handlebars/ETA/EJS).

На сервере подставляем данные → рендерим HTML → в Gotenberg (Chrome) конвертируем в PDF.

Даёт стабильную вёрстку, быстрый прогон, не требует AcroForm.

Вариант B (DOCX → PDF):

Шаблон — DOCX (плейсхолдеры вида ${full_name});

Подстановка сервером → конвертация в PDF через LibreOffice (Gotenberg умеет).

Технические требования:

Кодировка UTF-8; шрифт с кириллицей (например, Inter/Roboto).

Поля страницы — как в исходнике (A4, портрет).

Водяной знак или футер с номером анкеты опционально.

5) Хранение и аудит

Таблица consents (минимум):

id, candidate_id, consent_version, consent_text_hash (SHA-256), signed_at (UTC), ip, user_agent, pdf_url, pdf_sha256, created_at.

PDF — в S3/MinIO: consents/{{candidate_id}}/{{timestamp}}_consent_v{{version}}.pdf (доступ только по presigned URL, TTL короткий).

Иммутабельность: PDF и запись аудита не редактируются (только «признать недействительным» отдельным флагом/связной записью).

6) Почтовые уведомления

Кому:

Кандидат — e-mail из анкеты;

Рекрутер — корпоративный e-mail (из карточки рекрутера/настроек).

Тема: Согласие на обработку ПДн — {{ФИО}}

Тело: кратко «Ваше согласие сформировано и приложено. Дата: {{signed_at_local}}. Версия: {{consent_version}}.»

Вложение: PDF; если >10 МБ — вложение/ссылка (presigned URL).

Логируем message-id и статус доставки.

7) Валидации (на стороне анкеты)

Поля для подстановки — обязательны: ФИО, адрес регистрации, паспорт (серия, номер, дата выдачи, кем выдан, код подразделения).

Форматы:

Паспорт РФ: серия \d{4}, номер \d{6};

Дата — YYYY-MM-DD;

Код подразделения — \d{3}-\d{3} или \d{6};

Адрес — непустая строка с индексом.

Если формат не проходит — показываем ошибку и не даём ставить чекбокс.


